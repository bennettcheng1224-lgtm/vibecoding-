<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>76DollShop ç®¡ç†å¾Œå°</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .admin-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        .admin-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .admin-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .email-list, .announcement-list {
            list-style: none;
            padding: 0;
        }
        .email-item, .announcement-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .email-item:hover, .announcement-item:hover {
            background: #f8fafc;
        }
        .add-email-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .add-email-form input {
            flex: 1;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
        }
        .edit-form {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 4px;
        }
        .edit-form.active {
            display: block;
        }
        .edit-form textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .edit-form input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1>ğŸ”§ 76DollShop ç®¡ç†å¾Œå°</h1>
            <div class="user-info">
                <span>ç®¡ç†å“¡ï¼š{{ user_email }}</span>
                <a class="btn btn-secondary" href="/">è¿”å›é¦–é </a>
                <a class="btn btn-secondary" href="/logout">ç™»å‡º</a>
            </div>
        </div>
    </header>

    <div class="admin-container">
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="announcements">å…¬å‘Šç®¡ç†</button>
            <button class="admin-tab" data-tab="emails">Email ç™½åå–®</button>
        </div>

        <!-- å…¬å‘Šç®¡ç† Tab -->
        <div id="announcements-tab" class="tab-content active">
            <div class="admin-section">
                <h2>ğŸ“¢ å…¬å‘Šç®¡ç†</h2>
                <p>é»æ“Šå…¬å‘Šé€²è¡Œç·¨è¼¯æˆ–åˆªé™¤</p>
                <ul id="admin-announcements-list" class="announcement-list">
                    <!-- å‹•æ…‹è¼‰å…¥ -->
                </ul>
            </div>
        </div>

        <!-- Email ç™½åå–® Tab -->
        <div id="emails-tab" class="tab-content">
            <div class="admin-section">
                <h2>ğŸ“§ Email ç™½åå–®ç®¡ç†</h2>
                <div class="add-email-form">
                    <input type="email" id="new-email-input" placeholder="è¼¸å…¥ Email åœ°å€" required>
                    <button class="btn btn-primary" id="add-email-btn">â• æ–°å¢</button>
                </div>
                <ul id="email-list" class="email-list">
                    <!-- å‹•æ…‹è¼‰å…¥ -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Edit Announcement Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç·¨è¼¯å…¬å‘Š</h2>
                <button class="close-modal" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ¨™é¡Œ</label>
                    <input type="text" id="edit-title" class="form-control">
                </div>
                <div class="form-group">
                    <label>å…§å®¹</label>
                    <textarea id="edit-content" rows="10"></textarea>
                </div>
                <div class="form-group">
                    <label>åˆ†é¡ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
                    <input type="text" id="edit-categories" placeholder="ä¾‹å¦‚: æ–°å“è³‡è¨Š,è¡Œæ”¿é€šçŸ¥">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                    <button class="btn btn-danger" onclick="deleteCurrentAnnouncement()">åˆªé™¤å…¬å‘Š</button>
                    <button class="btn btn-primary" onclick="saveAnnouncement()">å„²å­˜è®Šæ›´</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentEditId = null;
        let allAnnouncements = {{ announcements | tojson }};
        let allEmails = {{ allowed_emails | tojson }};

        // Tab åˆ‡æ›
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            });
        });

        // è¼‰å…¥å…¬å‘Šåˆ—è¡¨
        function loadAnnouncements() {
            const list = document.getElementById('admin-announcements-list');
            list.innerHTML = allAnnouncements.map(ann => `
                <li class="announcement-item">
                    <div>
                        <strong>${escapeHtml(ann.title)}</strong>
                        <p style="color: #64748b; font-size: 14px; margin: 5px 0 0 0;">
                            ${escapeHtml(ann.content.substring(0, 100))}${ann.content.length > 100 ? '...' : ''}
                        </p>
                        <small style="color: #94a3b8;">${new Date(ann.date).toLocaleString('zh-TW')}</small>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="editAnnouncement('${ann.id}')">ç·¨è¼¯</button>
                        <button class="btn btn-danger" onclick="deleteAnnouncementDirect('${ann.id}', '${escapeHtml(ann.title).replace(/'/g, "\\'")}')">åˆªé™¤</button>
                    </div>
                </li>
            `).join('');
        }

        // è¼‰å…¥ Email åˆ—è¡¨
        function loadEmails() {
            const list = document.getElementById('email-list');
            list.innerHTML = allEmails.map(email => `
                <li class="email-item">
                    <div>
                        <strong>${escapeHtml(email.email)}</strong>
                        <small style="color: #64748b; display: block;">
                            æ–°å¢è€…ï¼š${escapeHtml(email.added_by)} |
                            ${new Date(email.created_at).toLocaleString('zh-TW')}
                        </small>
                    </div>
                    <button class="btn btn-danger" onclick="deleteEmail(${email.id}, '${escapeHtml(email.email)}')">åˆªé™¤</button>
                </li>
            `).join('');
        }

        // æ–°å¢ Email
        document.getElementById('add-email-btn').addEventListener('click', async () => {
            const input = document.getElementById('new-email-input');
            const email = input.value.trim();

            if (!email) {
                alert('è«‹è¼¸å…¥ Email');
                return;
            }

            try {
                const response = await fetch('/admin/api/allowed-emails', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email})
                });

                const data = await response.json();

                if (data.success) {
                    alert(`âœ… Email ${email} å·²æ–°å¢`);
                    input.value = '';
                    // é‡æ–°è¼‰å…¥åˆ—è¡¨
                    const emailsResponse = await fetch('/admin/api/allowed-emails');
                    const emailsData = await emailsResponse.json();
                    allEmails = emailsData.emails;
                    loadEmails();
                } else {
                    alert('âŒ ' + (data.detail || 'æ–°å¢å¤±æ•—'));
                }
            } catch (error) {
                alert('âŒ æ–°å¢å¤±æ•—ï¼š' + error.message);
            }
        });

        // åˆªé™¤ Email
        async function deleteEmail(id, email) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ Email ${email} å—ï¼Ÿ`)) return;

            try {
                const response = await fetch(`/admin/api/allowed-emails/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert(`âœ… Email ${email} å·²åˆªé™¤`);
                    // é‡æ–°è¼‰å…¥åˆ—è¡¨
                    const emailsResponse = await fetch('/admin/api/allowed-emails');
                    const emailsData = await emailsResponse.json();
                    allEmails = emailsData.emails;
                    loadEmails();
                } else {
                    alert('âŒ ' + (data.detail || 'åˆªé™¤å¤±æ•—'));
                }
            } catch (error) {
                alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        // ç·¨è¼¯å…¬å‘Š
        async function editAnnouncement(id) {
            currentEditId = id;
            const ann = allAnnouncements.find(a => a.id === id);

            document.getElementById('edit-title').value = ann.title;
            document.getElementById('edit-content').value = ann.content;
            document.getElementById('edit-categories').value = ann.categories.join(', ');

            document.getElementById('edit-modal').classList.add('active');
        }

        // å„²å­˜å…¬å‘Š
        async function saveAnnouncement() {
            const title = document.getElementById('edit-title').value.trim();
            const content = document.getElementById('edit-content').value.trim();
            const categoriesStr = document.getElementById('edit-categories').value.trim();
            const categories = categoriesStr.split(',').map(c => c.trim()).filter(c => c);

            if (!title || !content) {
                alert('æ¨™é¡Œå’Œå…§å®¹ä¸èƒ½ç‚ºç©º');
                return;
            }

            try {
                const response = await fetch(`/admin/api/announcements/${currentEditId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title, content, categories})
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… å…¬å‘Šå·²æ›´æ–°');
                    closeEditModal();
                    location.reload();
                } else {
                    alert('âŒ æ›´æ–°å¤±æ•—');
                }
            } catch (error) {
                alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + error.message);
            }
        }

        // åˆªé™¤å…¬å‘Š
        async function deleteCurrentAnnouncement() {
            const ann = allAnnouncements.find(a => a.id === currentEditId);
            await deleteAnnouncementDirect(currentEditId, ann.title);
        }

        async function deleteAnnouncementDirect(id, title) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å…¬å‘Šã€Œ${title}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;

            try {
                const response = await fetch(`/api/announcements/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… å…¬å‘Šå·²åˆªé™¤');
                    location.reload();
                } else {
                    alert('âŒ åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
            currentEditId = null;
        }

        function escapeHtml(text) {
            const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        // åˆå§‹åŒ–
        loadAnnouncements();
        loadEmails();
    </script>
</body>
</html>
