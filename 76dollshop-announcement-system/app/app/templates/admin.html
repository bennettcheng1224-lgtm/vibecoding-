<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>76DollShop ç®¡ç†å¾Œå°</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .admin-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        .admin-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .admin-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .email-list, .announcement-list {
            list-style: none;
            padding: 0;
        }
        .email-item, .announcement-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .email-item:hover, .announcement-item:hover {
            background: #f8fafc;
        }
        .add-email-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .add-email-form input {
            flex: 1;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
        }
        .edit-form {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 4px;
        }
        .edit-form.active {
            display: block;
        }
        .edit-form textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .edit-form input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #334155;
        }
        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group textarea {
            resize: vertical;
            font-family: inherit;
        }
        .category-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .category-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .custom-category-input {
            display: flex;
            gap: 10px;
        }
        .custom-category-input input {
            flex: 1;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1>ğŸ”§ 76DollShop ç®¡ç†å¾Œå°</h1>
            <div class="user-info">
                <span>ç®¡ç†å“¡ï¼š{{ user_email }}</span>
                <a class="btn btn-secondary" href="/">è¿”å›é¦–é </a>
                <a class="btn btn-secondary" href="/logout">ç™»å‡º</a>
            </div>
        </div>
    </header>

    <div class="admin-container">
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="create">ç™¼å¸ƒæ–°å…¬å‘Š</button>
            <button class="admin-tab" data-tab="announcements">å…¬å‘Šç®¡ç†</button>
            <button class="admin-tab" data-tab="categories">åˆ†é¡ç®¡ç†</button>
            <button class="admin-tab" data-tab="emails">Email ç™½åå–®</button>
        </div>

        <!-- ç™¼å¸ƒæ–°å…¬å‘Š Tab -->
        <div id="create-tab" class="tab-content active">
            <div class="admin-section">
                <h2>ğŸ“ ç™¼å¸ƒæ–°å…¬å‘Š</h2>
                <form id="create-form">
                    <div class="form-group">
                        <label for="posterName">ç™¼å¸ƒè€…å§“å</label>
                        <input id="posterName" type="text" required placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
                    </div>

                    <div class="form-group">
                        <label for="title">æ¨™é¡Œ</label>
                        <input id="title" type="text" required placeholder="å…¬å‘Šæ¨™é¡Œ">
                    </div>

                    <div class="form-group">
                        <label for="content">å…§å®¹</label>
                        <textarea id="content" required placeholder="å…¬å‘Šå…§å®¹..." rows="6"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="categories">åˆ†é¡æ¨™ç±¤ï¼ˆå¯å¤šé¸ï¼‰</label>
                        <div id="category-checkboxes" class="category-checkboxes">
                            <!-- å‹•æ…‹ç”Ÿæˆçš„åˆ†é¡é¸é … -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="custom-category">è‡ªè¨‚åˆ†é¡ï¼ˆé¸å¡«ï¼‰</label>
                        <div class="custom-category-input">
                            <input id="custom-category" type="text" placeholder="è¼¸å…¥è‡ªè¨‚åˆ†é¡æ¨™ç±¤...">
                            <button id="add-custom-category-btn" class="btn btn-secondary" type="button">â• åŠ å…¥ç‚ºé è¨­é¸é …</button>
                        </div>
                    </div>

                    <button class="btn btn-primary" type="submit">ç™¼å¸ƒå…¬å‘Š</button>
                </form>
            </div>
        </div>

        <!-- å…¬å‘Šç®¡ç† Tab -->
        <div id="announcements-tab" class="tab-content">
            <div class="admin-section">
                <h2>ğŸ“¢ å…¬å‘Šç®¡ç†</h2>
                <p>é»æ“Šå…¬å‘Šé€²è¡Œç·¨è¼¯æˆ–åˆªé™¤</p>
                <ul id="admin-announcements-list" class="announcement-list">
                    <!-- å‹•æ…‹è¼‰å…¥ -->
                </ul>
            </div>
        </div>

        <!-- åˆ†é¡ç®¡ç† Tab -->
        <div id="categories-tab" class="tab-content">
            <div class="admin-section">
                <h2>ğŸ·ï¸ åˆ†é¡ç®¡ç†</h2>
                <div class="add-email-form">
                    <input type="text" id="new-category-input" placeholder="è¼¸å…¥åˆ†é¡åç¨±ï¼ˆä¾‹å¦‚ï¼šæ–°å“è³‡è¨Šã€è¡Œæ”¿é€šçŸ¥ï¼‰" style="flex: 3;">
                    <button class="btn btn-primary" id="add-category-btn">â• æ–°å¢åˆ†é¡</button>
                </div>
                <ul id="category-list" class="email-list">
                    <!-- å‹•æ…‹è¼‰å…¥ -->
                </ul>
            </div>
        </div>

        <!-- Email ç™½åå–® Tab -->
        <div id="emails-tab" class="tab-content">
            <div class="admin-section">
                <h2>ğŸ“§ Email ç™½åå–®ç®¡ç†</h2>
                <div class="add-email-form">
                    <input type="email" id="new-email-input" placeholder="è¼¸å…¥ Email åœ°å€" required style="flex: 2;">
                    <input type="text" id="new-employee-name-input" placeholder="å“¡å·¥å§“åï¼ˆé¸å¡«ï¼‰" style="flex: 1;">
                    <button class="btn btn-primary" id="add-email-btn">â• æ–°å¢</button>
                </div>
                <ul id="email-list" class="email-list">
                    <!-- å‹•æ…‹è¼‰å…¥ -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Edit Announcement Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç·¨è¼¯å…¬å‘Š</h2>
                <button class="close-modal" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ¨™é¡Œ</label>
                    <input type="text" id="edit-title" class="form-control">
                </div>
                <div class="form-group">
                    <label>å…§å®¹</label>
                    <textarea id="edit-content" rows="10"></textarea>
                </div>
                <div class="form-group">
                    <label>åˆ†é¡ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
                    <input type="text" id="edit-categories" placeholder="ä¾‹å¦‚: æ–°å“è³‡è¨Š,è¡Œæ”¿é€šçŸ¥">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                    <button class="btn btn-danger" onclick="deleteCurrentAnnouncement()">åˆªé™¤å…¬å‘Š</button>
                    <button class="btn btn-primary" onclick="saveAnnouncement()">å„²å­˜è®Šæ›´</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentEditId = null;
        let allAnnouncements = {{ announcements | tojson }};
        let allEmails = {{ allowed_emails | tojson }};

        // Tab åˆ‡æ›
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            });
        });

        // è¼‰å…¥å…¬å‘Šåˆ—è¡¨
        function loadAnnouncements() {
            const list = document.getElementById('admin-announcements-list');
            list.innerHTML = allAnnouncements.map(ann => `
                <li class="announcement-item">
                    <div>
                        <strong>${escapeHtml(ann.title)}</strong>
                        <p style="color: #64748b; font-size: 14px; margin: 5px 0 0 0;">
                            ${escapeHtml(ann.content.substring(0, 100))}${ann.content.length > 100 ? '...' : ''}
                        </p>
                        <small style="color: #94a3b8;">${new Date(ann.date).toLocaleString('zh-TW')}</small>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="editAnnouncement('${ann.id}')">ç·¨è¼¯</button>
                        <button class="btn btn-danger" onclick="deleteAnnouncementDirect('${ann.id}', '${escapeHtml(ann.title).replace(/'/g, "\\'")}')">åˆªé™¤</button>
                    </div>
                </li>
            `).join('');
        }

        // è¼‰å…¥ Email åˆ—è¡¨
        function loadEmails() {
            const list = document.getElementById('email-list');
            list.innerHTML = allEmails.map(email => `
                <li class="email-item">
                    <div>
                        <strong>${escapeHtml(email.email)}</strong>
                        ${email.employee_name ? `<span style="color: #2563eb; margin-left: 10px;">ğŸ‘¤ ${escapeHtml(email.employee_name)}</span>` : ''}
                        <small style="color: #64748b; display: block;">
                            æ–°å¢è€…ï¼š${escapeHtml(email.added_by)} |
                            ${new Date(email.created_at).toLocaleString('zh-TW')}
                        </small>
                    </div>
                    <button class="btn btn-danger" onclick="deleteEmail(${email.id}, '${escapeHtml(email.email)}')">åˆªé™¤</button>
                </li>
            `).join('');
        }

        // æ–°å¢ Email
        document.getElementById('add-email-btn').addEventListener('click', async () => {
            const emailInput = document.getElementById('new-email-input');
            const nameInput = document.getElementById('new-employee-name-input');
            const email = emailInput.value.trim();
            const employee_name = nameInput.value.trim() || null;

            if (!email) {
                alert('è«‹è¼¸å…¥ Email');
                return;
            }

            try {
                const response = await fetch('/admin/api/allowed-emails', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, employee_name})
                });

                const data = await response.json();

                if (data.success) {
                    alert(`âœ… Email ${email} å·²æ–°å¢`);
                    emailInput.value = '';
                    nameInput.value = '';
                    // é‡æ–°è¼‰å…¥åˆ—è¡¨
                    const emailsResponse = await fetch('/admin/api/allowed-emails');
                    const emailsData = await emailsResponse.json();
                    allEmails = emailsData.emails;
                    loadEmails();
                } else {
                    alert('âŒ ' + (data.detail || 'æ–°å¢å¤±æ•—'));
                }
            } catch (error) {
                alert('âŒ æ–°å¢å¤±æ•—ï¼š' + error.message);
            }
        });

        // åˆªé™¤ Email
        async function deleteEmail(id, email) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ Email ${email} å—ï¼Ÿ`)) return;

            try {
                const response = await fetch(`/admin/api/allowed-emails/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert(`âœ… Email ${email} å·²åˆªé™¤`);
                    // é‡æ–°è¼‰å…¥åˆ—è¡¨
                    const emailsResponse = await fetch('/admin/api/allowed-emails');
                    const emailsData = await emailsResponse.json();
                    allEmails = emailsData.emails;
                    loadEmails();
                } else {
                    alert('âŒ ' + (data.detail || 'åˆªé™¤å¤±æ•—'));
                }
            } catch (error) {
                alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        // ç·¨è¼¯å…¬å‘Š
        async function editAnnouncement(id) {
            currentEditId = id;
            const ann = allAnnouncements.find(a => a.id === id);

            document.getElementById('edit-title').value = ann.title;
            document.getElementById('edit-content').value = ann.content;
            document.getElementById('edit-categories').value = ann.categories.join(', ');

            document.getElementById('edit-modal').classList.add('active');
        }

        // å„²å­˜å…¬å‘Š
        async function saveAnnouncement() {
            const title = document.getElementById('edit-title').value.trim();
            const content = document.getElementById('edit-content').value.trim();
            const categoriesStr = document.getElementById('edit-categories').value.trim();
            const categories = categoriesStr.split(',').map(c => c.trim()).filter(c => c);

            if (!title || !content) {
                alert('æ¨™é¡Œå’Œå…§å®¹ä¸èƒ½ç‚ºç©º');
                return;
            }

            try {
                const response = await fetch(`/admin/api/announcements/${currentEditId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title, content, categories})
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… å…¬å‘Šå·²æ›´æ–°');
                    closeEditModal();
                    location.reload();
                } else {
                    alert('âŒ æ›´æ–°å¤±æ•—');
                }
            } catch (error) {
                alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + error.message);
            }
        }

        // åˆªé™¤å…¬å‘Š
        async function deleteCurrentAnnouncement() {
            const ann = allAnnouncements.find(a => a.id === currentEditId);
            await deleteAnnouncementDirect(currentEditId, ann.title);
        }

        async function deleteAnnouncementDirect(id, title) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å…¬å‘Šã€Œ${title}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;

            try {
                const response = await fetch(`/api/announcements/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… å…¬å‘Šå·²åˆªé™¤');
                    location.reload();
                } else {
                    alert('âŒ åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
            currentEditId = null;
        }

        function escapeHtml(text) {
            const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        // è¼‰å…¥åˆ†é¡åˆ—è¡¨
        async function loadCategories() {
            try {
                const response = await fetch('/admin/api/categories');
                const data = await response.json();
                const list = document.getElementById('category-list');

                list.innerHTML = data.categories.map(cat => `
                    <li class="email-item">
                        <div>
                            <strong>${escapeHtml(cat.name)}</strong>
                            <small style="color: #64748b; display: block;">
                                ä½¿ç”¨æ¬¡æ•¸ï¼š${cat.usage_count} å€‹å…¬å‘Š
                            </small>
                        </div>
                        <button class="btn btn-danger" onclick="deleteCategory(${cat.id}, '${escapeHtml(cat.name)}', ${cat.usage_count})">åˆªé™¤</button>
                    </li>
                `).join('');
            } catch (error) {
                console.error('è¼‰å…¥åˆ†é¡å¤±æ•—ï¼š', error);
            }
        }

        // æ–°å¢åˆ†é¡
        document.getElementById('add-category-btn').addEventListener('click', async () => {
            const input = document.getElementById('new-category-input');
            const name = input.value.trim();

            if (!name) {
                alert('è«‹è¼¸å…¥åˆ†é¡åç¨±');
                return;
            }

            try {
                const response = await fetch('/admin/api/categories', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name})
                });

                const data = await response.json();

                if (data.success) {
                    alert(`âœ… åˆ†é¡ã€Œ${name}ã€å·²æ–°å¢`);
                    input.value = '';
                    loadCategories();
                } else {
                    alert('âŒ ' + (data.detail || 'æ–°å¢å¤±æ•—'));
                }
            } catch (error) {
                alert('âŒ æ–°å¢å¤±æ•—ï¼š' + error.message);
            }
        });

        // åˆªé™¤åˆ†é¡
        async function deleteCategory(id, name, usageCount) {
            if (usageCount > 0) {
                if (!confirm(`åˆ†é¡ã€Œ${name}ã€ç›®å‰è¢« ${usageCount} å€‹å…¬å‘Šä½¿ç”¨ï¼Œ\nç¢ºå®šè¦åˆªé™¤å—ï¼Ÿåˆªé™¤å¾Œé€™äº›å…¬å‘Šå°‡å¤±å»æ­¤åˆ†é¡æ¨™ç±¤ã€‚`)) {
                    return;
                }
            } else {
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤åˆ†é¡ã€Œ${name}ã€å—ï¼Ÿ`)) {
                    return;
                }
            }

            try {
                const response = await fetch(`/admin/api/categories/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert(`âœ… åˆ†é¡ã€Œ${name}ã€å·²åˆªé™¤`);
                    loadCategories();
                } else {
                    alert('âŒ ' + (data.detail || 'åˆªé™¤å¤±æ•—'));
                }
            } catch (error) {
                alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        // è¼‰å…¥æ‰€æœ‰åˆ†é¡ï¼ˆç”¨æ–¼å»ºç«‹å…¬å‘Šè¡¨å–®ï¼‰
        async function loadCategoriesForForm() {
            try {
                const response = await fetch('/admin/api/categories');
                const data = await response.json();
                const container = document.getElementById('category-checkboxes');

                container.innerHTML = data.categories.map(cat => `
                    <label class="category-checkbox">
                        <input type="checkbox" name="category" value="${escapeHtml(cat.name)}">
                        ${escapeHtml(cat.name)}
                    </label>
                `).join('');
            } catch (error) {
                console.error('è¼‰å…¥åˆ†é¡å¤±æ•—ï¼š', error);
            }
        }

        // è™•ç†ç™¼å¸ƒæ–°å…¬å‘Šè¡¨å–®
        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const posterName = document.getElementById('posterName').value.trim();
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();

            // æ”¶é›†é¸ä¸­çš„åˆ†é¡
            const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked'))
                .map(checkbox => checkbox.value);

            // åŠ å…¥è‡ªè¨‚åˆ†é¡ï¼ˆå¦‚æœæœ‰å¡«å¯«ï¼‰
            const customCategory = document.getElementById('custom-category').value.trim();
            if (customCategory && !selectedCategories.includes(customCategory)) {
                selectedCategories.push(customCategory);
            }

            if (!posterName || !title || !content) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }

            try {
                const response = await fetch('/api/announcements', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        posterName,
                        title,
                        content,
                        categories: selectedCategories
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… å…¬å‘Šå·²ç™¼å¸ƒï¼');
                    // æ¸…ç©ºè¡¨å–®
                    document.getElementById('create-form').reset();
                    // é‡æ–°è¼‰å…¥åˆ†é¡é¸é …
                    loadCategoriesForForm();
                    // é‡æ–°è¼‰å…¥å…¬å‘Šåˆ—è¡¨
                    location.reload();
                } else {
                    alert('âŒ ç™¼å¸ƒå¤±æ•—');
                }
            } catch (error) {
                alert('âŒ ç™¼å¸ƒå¤±æ•—ï¼š' + error.message);
            }
        });

        // åŠ å…¥è‡ªè¨‚åˆ†é¡åˆ°è³‡æ–™åº«
        document.getElementById('add-custom-category-btn').addEventListener('click', async () => {
            const input = document.getElementById('custom-category');
            const name = input.value.trim();

            if (!name) {
                alert('è«‹è¼¸å…¥åˆ†é¡åç¨±');
                return;
            }

            try {
                const response = await fetch('/admin/api/categories', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name})
                });

                const data = await response.json();

                if (data.success) {
                    alert(`âœ… åˆ†é¡ã€Œ${name}ã€å·²åŠ å…¥é è¨­é¸é …`);
                    input.value = '';
                    loadCategoriesForForm();
                } else {
                    alert('âŒ ' + (data.detail || 'æ–°å¢å¤±æ•—'));
                }
            } catch (error) {
                alert('âŒ æ–°å¢å¤±æ•—ï¼š' + error.message);
            }
        });

        // Tab åˆ‡æ›æ™‚è¼‰å…¥å°æ‡‰è³‡æ–™
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                if (tabName === 'categories') {
                    loadCategories();
                } else if (tabName === 'emails') {
                    loadEmails();
                } else if (tabName === 'create') {
                    loadCategoriesForForm();
                }
            });
        });

        // åˆå§‹åŒ–
        loadAnnouncements();
        loadEmails();
        loadCategoriesForForm();
    </script>
</body>
</html>
